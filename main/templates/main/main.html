{% extends "base.html" %}
{% load django_bootstrap5 %}
{% load static %}

{% block content %}
{% csrf_token %}
<div class="container my-5">
  <!-- Logo principal -->

  {% if user.is_authenticated %}
  <!-- Dashboard utilisateur -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <h2 class="text-primary mb-1">Bonjour {{ user.first_name|default:user.username }} !</h2>
              <p class="text-muted mb-0">Bienvenue dans votre espace de planification pédagogique</p>
            </div>
            <div class="text-end">
              <small class="text-muted">{{ "now"|date:"l d F Y" }}</small>
            </div>
          </div>
          
          <!-- Actions rapides -->
          <div class="row g-3">
            <div class="col-md-3">
              <a href="{% url 'disciplines' %}" class="btn btn-primary btn-lg w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3">
                <i class="fas fa-book mb-2" style="font-size: 2rem;"></i>
                <span class="fw-bold">Mes Disciplines</span>
                <small class="opacity-75">Gérer mes matières</small>
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'calendar' %}" class="btn btn-success btn-lg w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3">
                <i class="fas fa-calendar-alt mb-2" style="font-size: 2rem;"></i>
                <span class="fw-bold">Calendrier</span>
                <small class="opacity-75">Planning des séances</small>
              </a>
            </div>
            <div class="col-md-3">
              <a href="{% url 'fiche_create' %}" class="btn btn-info btn-lg w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3">
                <i class="fas fa-plus mb-2" style="font-size: 2rem;"></i>
                <span class="fw-bold">Nouvelle Fiche</span>
                <small class="opacity-75">Créer une séance</small>
              </a>
            </div>
            <div class="col-md-3">
              <a href="#" class="btn btn-warning btn-lg w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3" data-bs-toggle="modal" data-bs-target="#shareModal">
                <i class="fas fa-share-alt mb-2" style="font-size: 2rem;"></i>
                <span class="fw-bold">Partager</span>
                <small class="opacity-75">Échanger des fiches</small>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Section de partage -->
  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Mes Fiches Partagées</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Gérez vos fiches mises à disposition de la communauté.</p>
          <a href="#" class="btn btn-outline-primary" onclick="loadMySharedFiches()">Voir mes partages</a>
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-download me-2"></i>Fiches de la Communauté</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Découvrez et importez des fiches partagées par d'autres enseignants.</p>
          <a href="#" class="btn btn-outline-success" onclick="loadCommunityFiches()">Explorer</a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}





  {% if not user.is_authenticated %}
  <!-- Section de retour vers la connexion -->
  <div class="row justify-content-center mt-5">
    <div class="col-md-10">
      <div class="card shadow-lg border-0">
        <div class="card-body text-center py-5">
          <div class="mb-4">
            <i class="bi bi-person-circle text-primary" style="font-size: 4rem;"></i>
          </div>
          <h2 class="card-title fw-bold mb-4 text-primary">
            Bienvenue sur Planif facile
          </h2>
          <p class="card-text mb-4 fs-5">
            Votre outil de planification de séances pédagogiques
          </p>
          <p class="card-text text-muted mb-5">
            Créez, organisez et gérez vos fiches de préparation en toute simplicité.
            Chaque utilisateur dispose de son espace personnel sécurisé.
          </p>
          
          <div class="row justify-content-center">
            <div class="col-md-8">
              <div class="d-grid gap-3">
                <a href="{% url 'login' %}" class="btn btn-primary btn-lg py-3">
                  <i class="bi bi-box-arrow-in-right me-2"></i>
                  <strong>Se connecter</strong>
                </a>
                <a href="{% url 'signup' %}" class="btn btn-outline-primary btn-lg py-3">
                  <i class="bi bi-person-plus me-2"></i>
                  <strong>Créer un compte</strong>
                </a>
              </div>
            </div>
          </div>
          
          <hr class="my-5">
          
          <div class="row text-start">
            <div class="col-md-4 mb-3">
              <div class="d-flex align-items-center">
                <i class="bi bi-check-circle-fill text-success me-3" style="font-size: 1.5rem;"></i>
                <div>
                  <h6 class="mb-1 fw-bold">Fiches personnalisées</h6>
                  <small class="text-muted">Créez vos propres modèles</small>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="d-flex align-items-center">
                <i class="bi bi-shield-check text-success me-3" style="font-size: 1.5rem;"></i>
                <div>
                  <h6 class="mb-1 fw-bold">Données sécurisées</h6>
                  <small class="text-muted">Accès privé et protégé</small>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="d-flex align-items-center">
                <i class="bi bi-lightning-fill text-success me-3" style="font-size: 1.5rem;"></i>
                <div>
                  <h6 class="mb-1 fw-bold">Interface simple</h6>
                  <small class="text-muted">Prise en main rapide</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

</div>

<!-- Modal de partage -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="shareModalLabel">
          <i class="fas fa-share-alt me-2"></i>Partager des Fiches
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-primary"><i class="fas fa-upload me-2"></i>Partager mes fiches</h6>
            <p class="text-muted small">Sélectionnez les fiches à partager avec la communauté</p>
            <div id="myFichesToShare" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
              <div class="text-center text-muted py-3">
                <i class="fas fa-spinner fa-spin"></i> Chargement...
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <h6 class="text-success"><i class="fas fa-download me-2"></i>Fiches disponibles</h6>
            <p class="text-muted small">Importez des fiches partagées par d'autres enseignants</p>
            <div id="communityFiches" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
              <div class="text-center text-muted py-3">
                <i class="fas fa-spinner fa-spin"></i> Chargement...
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
// Charger mes fiches pour partage
function loadMySharedFiches() {
  $('#shareModal').modal('show');
  loadMyFichesToShare();
}

// Charger les fiches de la communauté
function loadCommunityFiches() {
  $('#shareModal').modal('show');
  loadAvailableFiches();
}

// Charger mes fiches disponibles pour partage
function loadMyFichesToShare() {
  fetch('/fiches/api/my-fiches-to-share/')
    .then(response => {
      if (response.status === 401) {
        // Rediriger vers la page de connexion si non authentifié
        window.location.href = '/fiches/login/';
        return;
      }
      return response.json();
    })
    .then(data => {
      if (!data) return; // Si redirection, pas de données
      
      const container = document.getElementById('myFichesToShare');
      if (data.success && data.fiches && data.fiches.length > 0) {
        // Sécurisation XSS : utilisation de DOM manipulation au lieu d'innerHTML
        container.innerHTML = '';
        data.fiches.forEach(fiche => {
          const ficheCard = createSecureFicheCard(fiche);
          container.appendChild(ficheCard);
        });
      } else if (data.success === false && data.error) {
        showSecureMessage(container, data.error, 'warning');
      } else {
        showSecureMessage(container, 'Aucune fiche disponible', 'muted');
      }
    })
    .catch(error => {
      console.error('Erreur:', error);
      const container = document.getElementById('myFichesToShare');
      showSecureMessage(container, 'Erreur de chargement', 'danger');
    });
}

// Charger les fiches disponibles de la communauté
function loadAvailableFiches() {
  fetch('/fiches/api/community-fiches/')
    .then(response => {
      if (response.status === 401) {
        // Rediriger vers la page de connexion si non authentifié
        window.location.href = '/fiches/login/';
        return;
      }
      return response.json();
    })
    .then(data => {
      if (!data) return; // Si redirection, pas de données
      
      const container = document.getElementById('communityFiches');
      if (data.success && data.fiches && data.fiches.length > 0) {
        container.innerHTML = data.fiches.map(fiche => `
          <div class="card mb-2">
            <div class="card-body p-2">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">${fiche.titre}</h6>
                  <small class="text-muted">${fiche.discipline_nom} - par ${fiche.auteur}</small>
                  <div class="mt-1">
                    <span class="badge bg-light text-dark">${fiche.niveau || 'Tous niveaux'}</span>
                  </div>
                </div>
                <button class="btn btn-sm btn-success" onclick="importFiche(${fiche.id})">
                  <i class="fas fa-download"></i> Importer
                </button>
              </div>
            </div>
          </div>
        `).join('');
      } else if (data.success === false && data.error) {
        container.innerHTML = `<div class="text-center text-warning py-3">${data.error}</div>`;
      } else {
        container.innerHTML = '<div class="text-center text-muted py-3">Aucune fiche disponible</div>';
      }
    })
    .catch(error => {
      console.error('Erreur:', error);
      document.getElementById('communityFiches').innerHTML = 
        '<div class="text-center text-danger py-3">Erreur de chargement</div>';
    });
}

// Fonction pour obtenir le token CSRF
function getCSRFToken() {
  const token = document.querySelector('[name=csrfmiddlewaretoken]');
  return token ? token.value : '';
}

// Basculer le partage d'une fiche
function toggleShare(ficheId, isShared) {
  const csrfToken = getCSRFToken();
  if (!csrfToken) {
    alert('Erreur: Token CSRF manquant');
    return;
  }
  
  fetch('/fiches/api/toggle-share/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({
      fiche_id: ficheId,
      is_shared: isShared
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Mettre à jour le label
      const label = document.querySelector(`label[for="share_${ficheId}"]`);
      label.textContent = isShared ? 'Partagé' : 'Privé';
    } else {
      alert('Erreur lors du partage');
      // Remettre l'état précédent
      document.getElementById(`share_${ficheId}`).checked = !isShared;
    }
  })
  .catch(error => {
    console.error('Erreur:', error);
    alert('Erreur lors du partage');
    document.getElementById(`share_${ficheId}`).checked = !isShared;
  });
}

// Importer une fiche de la communauté
function importFiche(ficheId) {
  if (confirm('Voulez-vous importer cette fiche dans votre espace personnel ?')) {
    const csrfToken = getCSRFToken();
    if (!csrfToken) {
      alert('Erreur: Token CSRF manquant');
      return;
    }
    
    fetch('/fiches/api/import-fiche/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        fiche_id: ficheId
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Fiche importée avec succès !');
        loadAvailableFiches(); // Recharger la liste
      } else {
        alert('Erreur lors de l\'importation: ' + (data.error || 'Erreur inconnue'));
      }
    })
    .catch(error => {
      console.error('Erreur:', error);
      alert('Erreur lors de l\'importation');
    });
  }
}

// Charger automatiquement les données quand le modal s'ouvre
document.addEventListener('DOMContentLoaded', function() {
  const shareModal = document.getElementById('shareModal');
  if (shareModal) {
    shareModal.addEventListener('shown.bs.modal', function () {
      loadMyFichesToShare();
      loadAvailableFiches();
    });
  }
});
</script>

<!-- Utilitaires de sécurité -->
<script src="{% load static %}{% static 'js/security-utils.js' %}"></script>

<!-- jQuery CDN pour compatibilité -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Version jQuery pour compatibilité avec Bootstrap
$(document).ready(function() {
  $('#shareModal').on('shown.bs.modal', function () {
    loadMyFichesToShare();
    loadAvailableFiches();
  });
});
</script>

{% endblock %}
