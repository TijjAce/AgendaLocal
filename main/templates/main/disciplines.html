{% extends "base.html" %}
{% load django_bootstrap5 %}

{% block content %}
<div class="container my-5">



  <!-- Disciplines Section -->
  <div class="text-center mb-5">
    <h1 class="display-4 fw-bold text-primary mb-3">Disciplines</h1>
    <p class="lead text-muted">Choisissez une discipline pour créer vos fiches de préparation</p>
  </div>

  {% if pages %}
    <div class="row g-4">
      {% for discipline in pages %}
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm border-0 discipline-card" 
               style="border-left: 5px solid {{ discipline.user_couleur|default:'#0d6efd' }} !important;">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                  <h5 class="card-title mb-0 fw-bold">{{ discipline.title }}</h5>
                </div>
                <!-- Modification de couleur personnalisée -->
                <form method="post" class="d-flex align-items-center gap-1">
                  {% csrf_token %}
                  <input type="hidden" name="discipline_id" value="{{ discipline.id }}">
                  <input type="color" name="couleur" value="{{ discipline.user_couleur|default:'#0d6efd' }}" 
                         class="form-control form-control-color" style="width: 35px; height: 35px; padding: 0; border: none;" title="Personnaliser ma couleur">
                  <button type="submit" class="btn btn-outline-secondary btn-sm" title="Sauvegarder ma couleur personnalisée">
                    <i class="fas fa-palette"></i>
                  </button>
                </form>
              </div>
              
              {% if discipline.content %}
                <p class="card-text text-muted flex-grow-1">{{ discipline.content|truncatewords:15|striptags }}</p>
              {% endif %}
              
              <!-- Séquences Section -->
              <div class="mb-3">
                <h6 class="fw-bold text-secondary mb-2">
                  <i class="fas fa-list-ol me-1"></i>Séquences
                </h6>
                <div class="sequences-list mb-2" id="sequences-{{ discipline.id }}">
                  <!-- Les séquences seront chargées ici -->
                  <div class="text-muted small">{{ discipline.nb_seances }} séance{{ discipline.nb_seances|pluralize }} créée{{ discipline.nb_seances|pluralize }}</div>
                </div>

              </div>
              
              <div class="mt-auto">
                <div class="d-flex gap-2">
                  <a href="{% url 'competences' discipline.id %}" class="btn btn-outline-primary btn-sm flex-grow-1">
                    <i class="fas fa-graduation-cap me-1"></i>Compétences
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-5">
      <div class="mb-4">
        <i class="fas fa-book fa-4x text-muted"></i>
      </div>
      <h3 class="text-muted">Aucune discipline disponible</h3>
      <p class="text-muted">Les disciplines seront affichées ici une fois configurées.</p>
    </div>
  {% endif %}

</div>

<style>
.discipline-card {
  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.discipline-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.discipline-color {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.sequence-item {
  background-color: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 8px 12px;
  margin-bottom: 6px;
  transition: all 0.2s ease;
}

.sequence-item:hover {
  background-color: #e9ecef;
  border-color: #dee2e6;
}

.sequence-actions {
  opacity: 0;
  transition: opacity 0.2s ease;
}

.sequence-item:hover .sequence-actions {
  opacity: 1;
}

.form-control-color {
  cursor: pointer;
}
</style>

<script>
// Fonction pour créer une nouvelle séquence
function createSequence(disciplineId) {
  // Rediriger vers la page de création de séquences avec la discipline pré-sélectionnée
  window.location.href = `/calendar/sequences/create/?discipline_id=${disciplineId}`;
}

// Fonction pour ajouter une séquence à la liste
function addSequenceToList(disciplineId, sequenceName, sequenceId) {
  const sequencesList = document.getElementById(`sequences-${disciplineId}`);
  
  // Supprimer le message "Aucune séquence créée" s'il existe
  const noSequenceMsg = sequencesList.querySelector('.text-muted');
  if (noSequenceMsg && noSequenceMsg.textContent.includes('Aucune séquence')) {
    noSequenceMsg.remove();
  }
  
  // Créer l'élément de séquence
  const sequenceDiv = document.createElement('div');
  sequenceDiv.className = 'sequence-item d-flex justify-content-between align-items-center';
  sequenceDiv.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="fas fa-list-ol me-2 text-secondary"></i>
      <span class="fw-medium">${sequenceName}</span>
    </div>
    <div class="sequence-actions">
      <button type="button" class="btn btn-outline-primary btn-xs me-1" 
              onclick="addFicheToSequence(${sequenceId})" title="Ajouter une fiche">
        <i class="fas fa-plus"></i>
      </button>
      <button type="button" class="btn btn-outline-danger btn-xs" 
              onclick="deleteSequence(${disciplineId}, ${sequenceId}, this)" title="Supprimer">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  `;
  
  sequencesList.appendChild(sequenceDiv);
}

// Fonction pour ajouter une fiche à une séquence
function addFicheToSequence(sequenceId) {
  // Rediriger vers la création de fiche avec la séquence pré-sélectionnée
  const disciplineId = getCurrentDisciplineId();
  window.location.href = `/fiches/create/?discipline_id=${disciplineId}&sequence_id=${sequenceId}`;
}

// Fonction pour supprimer une séquence
function deleteSequence(disciplineId, sequenceId, buttonElement) {
  if (confirm('Êtes-vous sûr de vouloir supprimer cette séquence ?')) {
    const sequenceItem = buttonElement.closest('.sequence-item');
    sequenceItem.remove();
    
    // Si plus de séquences, remettre le message
    const sequencesList = document.getElementById(`sequences-${disciplineId}`);
    if (sequencesList.children.length === 0) {
      const noSequenceMsg = document.createElement('div');
      noSequenceMsg.className = 'text-muted small';
      noSequenceMsg.textContent = 'Aucune séquence créée';
      sequencesList.appendChild(noSequenceMsg);
    }
  }
}

// Fonction utilitaire pour obtenir l'ID de discipline actuel
function getCurrentDisciplineId() {
  // Cette fonction devra être adaptée selon le contexte
  return 1; // Placeholder
}

// Charger les séquences existantes au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
  // Ici, on pourrait faire un appel AJAX pour charger les séquences existantes
  // loadExistingSequences();
});
</script>
{% endblock %}
