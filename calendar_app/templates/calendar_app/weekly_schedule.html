{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block title %}Semaine {{ week }} - {{ year }}{% endblock %}

{% block content %}
<style>
.weekly-schedule-container { max-width: 1400px; margin: 0 auto; }
.schedule-header { background: linear-gradient(135deg,#007bff,#0056b3); color:#fff; padding:2rem; border-radius:10px 10px 0 0; text-align:center; }
.schedule-header h1 { margin:0; font-size:1.8rem; font-weight:600; }
.week-navigation { display:flex; justify-content:center; gap:1rem; margin-top:1rem; }
.schedule-content { background:#fff; border-radius:0 0 10px 10px; overflow:hidden; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
.schedule-controls { padding:1rem; background:#f8f9fa; border-bottom:1px solid #dee2e6; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1rem; }
.weekly-overview { background:#f1f3f5; border-radius:10px; padding:15px; }

.day-card { 
    background:#fff; 
    border:1px solid #dee2e6; 
    border-radius:8px; 
    overflow:hidden; 
    transition:all 0.3s ease; 
    position:relative; 
    display: flex;
    flex-direction: column;
}

.day-card:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.1); }

.day-header { 
    background:#007bff; 
    color:white; 
    border-bottom:1px solid #dee2e6; 
    padding: 0.75rem;
    text-align: center;
    position: relative;
}

.day-name { 
    font-size:0.9rem; 
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.day-date { 
    font-size:0.75rem; 
    opacity:0.9; 
}

.day-body {
    display: flex;
    flex: 1;
}

.time-sidebar {
    width: 50px;
    background: #f8f9fa;
    border-right: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
}

.time-slot {
    height: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.6rem;
    color: #6c757d;
    border-bottom: 1px solid #e9ecef;
}

.time-slot:last-child {
    border-bottom: none;
}

.day-schedule { 
    min-height:400px; 
    position:relative; 
    flex: 1;
    padding: 2px;
}

.session-block { 
    border-radius:4px; 
    padding: 3px 6px; 
    margin:1px 0; 
    cursor:pointer; 
    transition:all 0.2s ease; 
    border-left:3px solid; 
    line-height:1.2; 
    position:absolute; 
    left:3px; 
    right:3px;
    font-size: clamp(0.5rem, 1.5vw, 0.75rem);
    overflow: hidden;
}

.session-planned { background:rgba(0,123,255,0.8); color:#fff; border-left-color:#0056b3; }
.session-done { background:rgba(40,167,69,0.8); color:#fff; border-left-color:#1e7e34; }
.session-block:hover { transform:scale(1.02); z-index:10; }

.session-time { 
    font-weight:600; 
    margin-bottom:1px; 
    font-size: inherit;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.session-title { margin-bottom:1px; }

.session-titre {
    display: inline-block;
    max-width: 80%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: middle;
    font-size: inherit;
    margin-left: 3px;
}

.session-discipline { 
    font-size: calc(1em - 0.1rem); 
    opacity:0.9; 
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.no-sessions { 
    font-size:0.8rem; 
    text-align:center; 
    padding:10px; 
    color: #6c757d;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.view-day-btn { 
    position:absolute; 
    top:5px; 
    right:5px; 
    font-size:0.7rem; 
    padding:2px 6px; 
    z-index: 5;
}

/* Responsive pour les petits écrans */
@media (max-width: 768px) {
    .session-block {
        font-size: clamp(0.45rem, 2.5vw, 0.65rem);
        padding: 2px 4px;
    }
    
    .time-sidebar {
        width: 40px;
    }
    
    .time-slot {
        font-size: 0.5rem;
        height: 20px;
    }
}

/* Pour les grands écrans */
@media (min-width: 1200px) {
    .session-block {
        font-size: clamp(0.6rem, 1vw, 0.8rem);
        padding: 4px 7px;
    }
    
    .time-sidebar {
        width: 55px;
    }
}
</style>

<div class="weekly-schedule-container">
    <div class="schedule-header">
        <h1>Semaine {{ week }} - {{ year }}</h1>
        <p class="mb-0">Du {{ week_start|date:"d/m/Y" }} au {{ week_end|date:"d/m/Y" }}</p>
        <div class="week-navigation">
            <a href="{% url 'weekly_schedule_with_params' prev_year prev_week %}" class="btn btn-outline-light">← Semaine précédente</a>
            <a href="{% url 'weekly_schedule' %}" class="btn btn-light">Semaine actuelle</a>
            <a href="{% url 'weekly_schedule_with_params' next_year next_week %}" class="btn btn-outline-light">Semaine suivante →</a>
        </div>
    </div>

    <div class="schedule-content">
        <div class="schedule-controls">
            <a href="{% url 'calendar' %}" class="btn btn-outline-secondary">← Retour au calendrier</a>
        </div>

        <div class="weekly-overview mb-4">
            <div class="row g-2">
                {% if week_data %}
                    {% for day in week_data %}
                        {% with day_name=day.0 day_date=day.1 sessions=day.2 %}
                            <div class="col">
                                <div class="day-card h-100">
                                    <div class="day-header">
                                        <div class="day-name">{{ day_name }}</div>
                                        <div class="day-date">{{ day_date|date:"d/m" }}</div>
                                        <a href="{% url 'daily_schedule' day_date.year day_date.month day_date.day %}" class="btn btn-sm btn-light view-day-btn">Voir journée</a>
                                    </div>

                                    <div class="day-body">
                                        <!-- Sidebar des horaires -->
                                        <div class="time-sidebar">
                                            {% for hour in "0607080910111213141516171819202122"|make_list %}
                                                {% if forloop.counter0|add:6 <= 22 %}
                                                    <div class="time-slot">
                                                        {% if forloop.counter0|divisibleby:2 %}
                                                            {{ forloop.counter0|add:6|stringformat:"02d" }}h
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>

                                        <!-- Zone des sessions -->
                                        <div class="day-schedule" data-day="{{ day_date|date:"Y-m-d" }}">
                                            {% if sessions %}
                                                {% for session in sessions %}
                                                    {% if session.titre and session.heure_debut and session.heure_fin %}
                                                        <div class="session-block {% if session.realise %}session-done{% else %}session-planned{% endif %}" 
                                                             draggable="true"
                                                             data-session-id="{{ session.id }}"
                                                             style="top: {{ session.top_position }}px; height: {{ session.height }}px;">
                                                            <div class="session-time">
                                                                {{ session.heure_debut|time:"H:i" }} - {{ session.heure_fin|time:"H:i" }}
                                                                <span class="session-titre">{{ session.titre }}</span>
                                                            </div>                                                        
                                                            <div class="session-discipline">{{ session.discipline.nom }}</div>
                                                        </div>
                                                    {% else %}
                                                        <div class="no-sessions">Session incomplète : {{ session.id }}</div>
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <div class="no-sessions">Aucune séance ce jour</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endwith %}
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="no-sessions text-center">Pas de données pour cette semaine</div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateSessionPosition(sessionId, newDate, newTop) {
    fetch("/calendar/update-session-position/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({
            session_id: sessionId,
            new_date: newDate,
            new_top: newTop
        })
    })
    .then(response => response.text())
    .then(text => {
        console.log("Réponse brute du serveur:", text);
        try {
            const data = JSON.parse(text);
            if(data.success){
                console.log("Position mise à jour ✅");
            } else {
                console.error("Erreur serveur:", data.error);
                alert("Erreur serveur: " + data.error);
            }
        } catch(e) {
            console.error("Impossible de parser JSON:", e);
        }
    })
    .catch(err => {
        console.error("Erreur fetch:", err);
        alert("Erreur lors de la communication avec le serveur");
    });
}

document.addEventListener('DOMContentLoaded', () => {
    const sessions = document.querySelectorAll('.session-block');
    const days = document.querySelectorAll('.day-schedule');

    sessions.forEach(session => {
        session.setAttribute("draggable", "true");

        session.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', session.dataset.sessionId);
            session.classList.add('dragging');
        });

        session.addEventListener('dragend', e => {
            session.classList.remove('dragging');
        });
    });

    days.forEach(day => {
        day.addEventListener('dragover', e => e.preventDefault());

        day.addEventListener('drop', e => {
            e.preventDefault();

            const sessionId = e.dataTransfer.getData('text/plain');
            const draggedSession = document.querySelector(`.session-block[data-session-id="${sessionId}"]`);

            const dayRect = day.getBoundingClientRect();
            const offsetY = e.clientY - dayRect.top;

            draggedSession.style.top = `${offsetY}px`;
            day.appendChild(draggedSession);

            updateSessionPosition(sessionId, day.dataset.day, offsetY);
        });
    });
});
</script>
{% endblock %}