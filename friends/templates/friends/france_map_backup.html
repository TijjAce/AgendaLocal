{% extends 'base.html' %}
{% load static %}

{% block title %}Carte de France - Amis{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin="" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .map-controls {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .friend-popup {
        text-align: center;
        min-width: 200px;
    }
    .friend-popup img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin-bottom: 10px;
    }
    .location-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }
    .bitmoji-marker {
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-map-marked-alt text-primary"></i> Carte des Amis</h2>
                <div>
                    <a href="{% url 'friends:dashboard' %}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-arrow-left"></i> Retour
                    </a>
                    <a href="{% url 'friends:update_profile' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-user-edit"></i> Mon Profil
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="map-controls">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5><i class="fas fa-info-circle text-info"></i> Instructions</h5>
                        <p class="mb-0">
                            {% if user_location %}
                                Votre position est affichée en vert. Vos amis apparaissent en bleu avec leurs Bitmojis.
                            {% else %}
                                <strong>Vous n'avez pas encore défini votre position.</strong> 
                                Cliquez sur la carte ou utilisez la géolocalisation pour vous positionner.
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        {% if not user_location %}
                        <button onclick="getCurrentLocation()" class="btn btn-success">
                            <i class="fas fa-location-arrow"></i> Me géolocaliser
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div id="map"></div>
        </div>
    </div>

    {% if not user_location %}
    <div class="row">
        <div class="col-12">
            <div class="location-form">
                <h5><i class="fas fa-map-pin"></i> Définir ma position</h5>
                <p>Cliquez sur la carte pour sélectionner votre position, puis remplissez les informations ci-dessous :</p>
                
                <form method="post" action="{% url 'friends:update_location_ajax' %}">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-3">
                            <label for="latitude" class="form-label">Latitude</label>
                            <input type="number" step="any" class="form-control" id="latitude" name="latitude" readonly>
                        </div>
                        <div class="col-md-3">
                            <label for="longitude" class="form-label">Longitude</label>
                            <input type="number" step="any" class="form-control" id="longitude" name="longitude" readonly>
                        </div>
                        <div class="col-md-3">
                            <label for="ville" class="form-label">Ville</label>
                            <input type="text" class="form-control" id="ville" name="ville" placeholder="Ex: Paris">
                        </div>
                        <div class="col-md-3">
                            <label for="departement" class="form-label">Département</label>
                            <input type="text" class="form-control" id="departement" name="departement" placeholder="Ex: 75" maxlength="3">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" id="submitLocation" class="btn btn-primary" disabled>
                            <i class="fas fa-save"></i> Enregistrer ma position
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Vérifier que Leaflet est chargé
        if (typeof L === 'undefined') {
            document.getElementById('map').innerHTML = '<div class="alert alert-danger">Erreur: Leaflet n\'est pas chargé. Veuillez rafraîchir la page.</div>';
            return;
        }

        // Initialiser la carte
        var map = L.map('map').setView([46.603354, 1.888334], 6);

        // Ajouter les tuiles OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Données des amis (sérialisées de manière sécurisée par Django)
        var friendsData = {{ friends_with_location|safe }};

        // Ajouter les marqueurs des amis
        friendsData.forEach(function(friend) {
            var iconHtml = friend.bitmoji ? 
            
            // Ajouter les marqueurs des amis
            if (Array.isArray(friendsData)) {
                friendsData.forEach(function(friend) {
                    if (friend.latitude && friend.longitude) {
                        var friendMarker = L.marker([friend.latitude, friend.longitude]);
                        
                        // Créer le contenu du popup simple
                        var popupContent = '<div class="friend-popup">';
                        popupContent += '<h6>' + (friend.username || 'Ami') + '</h6>';
                        
                        if (friend.ville) {
                            popupContent += '<p>' + friend.ville + '</p>';
                        }
                        
                        popupContent += '</div>';
                        
                        friendMarker.bindPopup(popupContent);
                        friendMarker.addTo(map);
                    }
                });
            }
        } catch (error) {
            console.error('Erreur lors du chargement des amis:', error);
        }

        // Données utilisateur (générées par Django)
        {% if user_location %}
        var userData = {
            lat: {{ user_location.0 }},
            lng: {{ user_location.1 }},
            ville: "{{ user.profile.ville|escapejs }}",
            departement: "{{ user.profile.departement|escapejs }}",
            bio: "{{ user.profile.bio|truncatechars:100|escapejs }}"
        };
        
        // Ajouter le marqueur de l'utilisateur
        var userIconHtml = userData.bitmoji ? 
            '<img src="' + userData.bitmoji + '" style="width: 50px; height: 50px; border-radius: 50%; border: 4px solid #28a745;">' :
            '<i class="fas fa-user-circle" style="color: #28a745; font-size: 50px;"></i>';
        
        var userIcon = L.divIcon({
            html: userIconHtml,
            iconSize: [50, 50],
            iconAnchor: [25, 50],
            popupAnchor: [0, -50],
            className: 'user-marker'
        });
        
        var userMarker = L.marker([userData.lat, userData.lng], {
            icon: userIcon
        }).addTo(map);
        
        var userPopupContent = '<div class="text-center">' +
            '<h6><i class="fas fa-star"></i> Vous</h6>';
        
        if (userData.ville) {
            userPopupContent += '<p><i class="fas fa-map-marker-alt"></i> ' + userData.ville;
            if (userData.departement) {
                userPopupContent += ' (' + userData.departement + ')';
            }
            userPopupContent += '</p>';
        }
        
        if (userData.bio) {
            userPopupContent += '<p class="small">' + userData.bio + '</p>';
        }
        
        userPopupContent += '</div>';
        
        userMarker.bindPopup(userPopupContent);
        {% endif %}
        
        // Variables globales
        var tempMarker = null;
        var updateLocationUrl = "{% url 'friends:update_location_ajax' %}";
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Fonction de géolocalisation
        window.getCurrentLocation = function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    
                    // Vérifier si c'est en France (approximatif)
                    if (lat >= 41.0 && lat <= 51.5 && lng >= -5.5 && lng <= 10.0) {
                        updateUserLocation(lat, lng);
                    } else {
                        alert('Vous ne semblez pas être en France. Veuillez sélectionner votre position manuellement sur la carte.');
                    }
                }, function(error) {
                    alert('Impossible d\'obtenir votre position. Veuillez sélectionner votre position manuellement sur la carte.');
                });
            } else {
                alert('La géolocalisation n\'est pas supportée par votre navigateur.');
            }
        };
        
        // Fonction de mise à jour de la position
        window.updateUserLocation = function(lat, lng) {
            fetch(updateLocationUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Erreur: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors de la sauvegarde de la position.');
            });
        };
        
        // Clic sur la carte pour sélectionner une position (seulement si pas de position)
        {% if not user_location %}
        map.on('click', function(e) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;
            
            // Supprimer l'ancien marqueur temporaire
            if (tempMarker) {
                map.removeLayer(tempMarker);
            }
            
            // Ajouter un nouveau marqueur temporaire
            tempMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    html: '<i class="fas fa-map-pin" style="color: #dc3545; font-size: 30px;"></i>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30],
                    popupAnchor: [0, -30],
                    className: 'temp-marker'
                })
            }).addTo(map);
            
            tempMarker.bindPopup('Position sélectionnée<br>Remplissez le formulaire ci-dessous').openPopup();
            
            // Mettre à jour les champs cachés
            var latField = document.getElementById('latitude');
            var lngField = document.getElementById('longitude');
            var submitBtn = document.getElementById('submitLocation');
            
            if (latField) latField.value = lat;
            if (lngField) lngField.value = lng;
            if (submitBtn) submitBtn.disabled = false;
        });
        {% endif %}
        
    } catch (error) {
        console.error('Erreur lors de l\'initialisation de la carte:', error);
        document.getElementById('map').innerHTML = '<div class="alert alert-danger">Erreur: Impossible d\'initialiser la carte. Veuillez rafraîchir la page.</div>';
    }
});
</script>
{% endblock %}
